#!/usr/bin/env bash
set -eux

# shellcheck disable=SC1091
source /var/vcap/jobs/garden/bin/envs
export CONTAINERD_CONFIG_FILEPATH="/var/vcap/jobs/garden/config/containerd.toml"
export LOG_DIR="/var/vcap/sys/log/garden"

export PATH="${PATH}:/var/vcap/packages/containerd/bin"
export PATH="${PATH}:/var/vcap/packages/runc/bin"

log() {
  local msg
  local time

  msg=$1
  <% if p("logging.format.timestamp") == "unix-epoch" -%>
  time=$(date -u +"%s.%N")
  <% else -%>
  time=$(date -u +"%Y-%m-%dT%H:%M:%S.%NZ")
  <% end -%>

  echo "$time $msg" >> "${LOG_DIR}/containerd_ctl.log"
}

start_containerd() {
  log "starting containerd"

  if pidof containerd; then
    echo "containerd already running"
    return
  fi


  containerd_config_filepath="$GARDEN_CONFIG_DIR/containerd.toml"
  exec_command="exec"
  <% if p("garden.experimental_rootless_mode") -%>
    maximus=$(/var/vcap/packages/garden-idmapper/bin/maximus)
    cp "$GARDEN_CONFIG_DIR/containerd.toml" "$GARDEN_ROOTLESS_CONFIG_DIR"
    chown "$maximus:$maximus" "$GARDEN_ROOTLESS_CONFIG_DIR/containerd.toml"
    containerd_config_filepath="$GARDEN_ROOTLESS_CONFIG_DIR/containerd.toml"

    exec_command="exec execas --uid $maximus --gid $maximus"
  <% end -%>

  log "running containerd"
  $exec_command /var/vcap/packages/containerd/bin/containerd -c "$containerd_config_filepath" \
    1>> "${LOG_DIR}/containerd.stdout.log" \
    2>> "${LOG_DIR}/containerd.stderr.log" \
    &
}

stop_containerd() {
  log "stopping containerd"
  killall -s SIGKILL containerd
}
