<% if p("bpm.enabled") %>
check process garden
  with pidfile /var/vcap/sys/run/bpm/garden/garden.pid
  start program "/var/vcap/jobs/bpm/bin/bpm start garden"
  stop program "/var/vcap/jobs/bpm/bin/bpm stop garden"
  group vcap

<% else %>
check process garden
  with pidfile /var/vcap/sys/run/garden/garden.pid
  start program "/var/vcap/jobs/garden/bin/garden_ctl start" with timeout 120 seconds
  stop program "/var/vcap/jobs/garden/bin/garden_ctl stop"


<% if p("garden.containerd_mode") -%>
  if failed unixsocket /var/vcap/sys/run/containerd/containerd.sock
    with timeout 5 seconds for 12 cycles
    then restart
<% end %>

  group vcap
<% end %>

check process garden-healthchecker
  with pidfile /var/vcap/sys/run/bpm/garden/garden-healthchecker.pid
  start program "/var/vcap/jobs/bpm/bin/bpm start garden -p garden-healthchecker"
  stop program "/var/vcap/jobs/bpm/bin/bpm stop garden -p garden-healthchecker"
  if 1 restarts within 1 cycles then exec  "/var/vcap/packages/garden-runc-healthchecker/bin/restart-monit-job garden <%= p('healthchecker.failure_counter_file') %>"
  depends on garden
  group vcap
