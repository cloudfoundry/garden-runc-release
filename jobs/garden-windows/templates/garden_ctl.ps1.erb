$ErrorActionPreference = "Stop";
trap { $host.SetShouldExit(1) }

$gardenDir="C:\var\vcap\data\garden"
$depotDir=(Join-Path $gardenDir "depot")
$imageStore=(Join-Path $gardenDir "image-store")

New-Item $depotDir -ItemType Directory -Force
New-Item $imageStore -ItemType Directory -Force

C:\var\vcap\packages\guardian-windows\gdn.exe `
  server `
  --skip-setup `
  --depot=$depotDir `
  --log-level=<%= p("garden.log_level") %> `
  <% ip, port = p("garden.listen_address").split(":") %> `
  --bind-ip=<%= ip %> `
  --bind-port=<%= port %> `
  --max-containers=<%= p("garden.max_containers") %> `
  <% if !p("garden.default_container_rootfs").empty? %> `
  --default-rootfs=<%= p("garden.default_container_rootfs") %> `
  <% end %> `
  --runtime-plugin=<%= p("garden.runtime_plugin") %> `
  --image-plugin=<%= p("garden.image_plugin") %> `
  --image-plugin-extra-arg=--store=$imageStore `
  --network-plugin=<%= p("garden.network_plugin") %> `
  <% p("garden.network_plugin_extra_args").each do |arg| %> `
  --network-plugin-extra-arg=<%= arg %> `
  <% end %> `
  --nstar-bin=<%= p("garden.nstar_bin") %> `
  --tar-bin=<%= p("garden.tar_bin") %> `
  <% if !p("garden.dropsonde.origin").empty? %> `
    --dropsonde-origin=<%= p("garden.dropsonde.origin") %> `
  <% end %> `
  <% if_p("garden.dropsonde.destination") do |destination| %> `
    --dropsonde-destination=<%= destination %> `
  <% end %> `
  <% if p("garden.destroy_containers_on_start") %> `
  --destroy-containers-on-startup `
  <% end %>
